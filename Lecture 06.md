---


---

<h2 id="stdfunction">Std::function</h2>
<h3 id="type-erasure----скрытие-объектов-разного-типа-за-одним-общим">Type erasure  - скрытие объектов разного типа за одним общим</h3>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token keyword">struct</span> function <span class="token punctuation">{</span>
	<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> F<span class="token operator">&gt;</span> <span class="token comment">//F имеет operator() и copyrable/moveable</span>
	<span class="token function">function</span><span class="token punctuation">(</span>F <span class="token keyword">const</span><span class="token operator">&amp;</span> f<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">ptr</span><span class="token punctuation">(</span>std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>model<span class="token operator">&lt;</span>F<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token function">function</span><span class="token punctuation">(</span>function <span class="token keyword">const</span><span class="token operator">&amp;</span> other<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">ptr</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>ptr <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword">bool</span> <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> ptr <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token keyword">private</span><span class="token operator">:</span>
	std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>concept<span class="token operator">&gt;</span> ptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> function<span class="token operator">::</span>concept <span class="token punctuation">{</span>
	<span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">concept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">virtual</span> unique_ptr<span class="token operator">&lt;</span>concept<span class="token operator">&gt;</span> <span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
	<span class="token keyword">virtual</span> <span class="token keyword">bool</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> F<span class="token operator">&gt;</span>
<span class="token keyword">struct</span> function<span class="token operator">::</span>model <span class="token operator">:</span> concept <span class="token punctuation">{</span>
	<span class="token function">model</span><span class="token punctuation">(</span>F f<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">f</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	unique_ptr<span class="token operator">&lt;</span>concept<span class="token operator">&gt;</span> <span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> make_unique<span class="token operator">&lt;</span>model<span class="token operator">&lt;</span>F<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">bool</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	F f<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>Примеры использования таких функций</p>
<pre class=" language-cpp"><code class="prism  language-cpp">any_iterator<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
any_range<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> 
any <span class="token operator">-</span> хранит любой тип внутри себя
</code></pre>
<h3 id="variadic-templates">Variadic templates</h3>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> A<span class="token operator">&gt;</span>
unique_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> make <span class="token function">unique</span><span class="token punctuation">(</span>A <span class="token operator">&amp;&amp;</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> unique_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">T</span><span class="token punctuation">(</span>forward<span class="token operator">&lt;</span>A<span class="token operator">&gt;</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>  

<span class="token function">f</span><span class="token punctuation">(</span><span class="token function">g</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token function">g</span><span class="token punctuation">(</span>a0<span class="token punctuation">,</span> a1<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> a3<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">f</span><span class="token punctuation">(</span><span class="token function">g</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token function">g</span><span class="token punctuation">(</span>a0<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">g</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">g</span><span class="token punctuation">(</span>a2<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
</code></pre>
<p><code>sizeof...</code> - указать количество элементов <strong>variadic templates</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp">Ну чо<span class="token punctuation">,</span> write из паскаля
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> A0<span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> As<span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span>A0 <span class="token keyword">const</span><span class="token operator">&amp;</span> a0<span class="token punctuation">,</span> As <span class="token keyword">const</span><span class="token operator">&amp;</span> as<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> a0<span class="token punctuation">;</span>
	<span class="token function">write</span><span class="token punctuation">(</span>as <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre>

